apiVersion: batch/v1
kind: Job
metadata:
  name: enroll-register-orderer-admin
spec:
  template:
    spec:
      restartPolicy: Never
      containers:
        - name: fabric-ca-client
          image: hyperledger/fabric-ca:latest
          command:
            - /bin/sh
            - -c
            - |
              set -e
              echo "===> ðŸ“¥ Enroll láº¡i Admin Ä‘á»ƒ Ä‘áº£m báº£o quyá»n register"

              ORG_DIR=/organizations/ordererOrganizations/example.com
              ADMIN_DIR=$ORG_DIR/admin
              mkdir -p "$ADMIN_DIR"
              export FABRIC_CA_CLIENT_HOME=$ADMIN_DIR

              # Enroll admin Ä‘á»ƒ láº¥y chá»©ng chá»‰
              fabric-ca-client enroll \
                -u https://admin:adminpw@ca-orderer:10054 \
                --caname ca-orderer \
                --tls.certfiles /organizations/fabric-ca/ordererOrg/tls-cert.pem

              echo "===> Ghi config.yaml cho NodeOUs"
              mkdir -p $ORG_DIR/msp
              cat <<EOF > $ORG_DIR/msp/config.yaml
              NodeOUs:
                Enable: true
                ClientOUIdentifier:
                  Certificate: cacerts/ca-orderer-10054-ca-orderer.pem
                  OrganizationalUnitIdentifier: client
                PeerOUIdentifier:
                  Certificate: cacerts/ca-orderer-10054-ca-orderer.pem
                  OrganizationalUnitIdentifier: peer
                AdminOUIdentifier:
                  Certificate: cacerts/ca-orderer-10054-ca-orderer.pem
                  OrganizationalUnitIdentifier: admin
                OrdererOUIdentifier:
                  Certificate: cacerts/ca-orderer-10054-ca-orderer.pem
                  OrganizationalUnitIdentifier: orderer
              EOF

              echo "===> ðŸ” ÄÄƒng kÃ½ cÃ¡c orderer nodes"
              ORDERERS="orderer orderer2 orderer3 orderer4 orderer5"

              for ord in $ORDERERS; do
                echo "ðŸ”¹ ÄÄƒng kÃ½ $ord"
                fabric-ca-client register --caname ca-orderer \
                  --id.name $ord \
                  --id.secret ordererpw \
                  --id.type orderer \
                  --tls.certfiles /organizations/fabric-ca/ordererOrg/tls-cert.pem || \
                  echo "âš ï¸  $ord Ä‘Ã£ Ä‘Æ°á»£c Ä‘Äƒng kÃ½ tá»« trÆ°á»›c"
              done

              echo "ðŸ”¹ ÄÄƒng kÃ½ ordererAdmin"
              fabric-ca-client register --caname ca-orderer \
                --id.name ordererAdmin \
                --id.secret ordererAdminpw \
                --id.type admin \
                --tls.certfiles /organizations/fabric-ca/ordererOrg/tls-cert.pem || \
                echo "âš ï¸  ordererAdmin Ä‘Ã£ Ä‘Æ°á»£c Ä‘Äƒng kÃ½ tá»« trÆ°á»›c"

              echo "===> ðŸ“¥ Enroll ordererAdmin"
              ORDERER_ADMIN_DIR=$ORG_DIR/users/Admin@example.com
              mkdir -p "$ORDERER_ADMIN_DIR"
              export FABRIC_CA_CLIENT_HOME=$ORDERER_ADMIN_DIR

              fabric-ca-client enroll \
                -u https://ordererAdmin:ordererAdminpw@ca-orderer:10054 \
                --caname ca-orderer \
                -M $ORDERER_ADMIN_DIR/msp \
                --tls.certfiles /organizations/fabric-ca/ordererOrg/tls-cert.pem

              cp $ORG_DIR/msp/config.yaml $ORDERER_ADMIN_DIR/msp/config.yaml

              echo "===> ðŸ›  Copy cacerts vÃ o msp/cacerts"
              mkdir -p $ORG_DIR/msp/cacerts
              cp $ORDERER_ADMIN_DIR/msp/cacerts/* $ORG_DIR/msp/cacerts/

              echo "âœ… HoÃ n táº¥t táº¥t cáº£ bÆ°á»›c enroll + register + copy cacerts"
          volumeMounts:
            - name: orgdata
              mountPath: /organizations
              subPath: organizations
      volumes:
        - name: orgdata
          persistentVolumeClaim:
            claimName: nfs-pvc